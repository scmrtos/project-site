{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const selectorDiv = document.createElement("div");
      selectorDiv.style.padding = "0.7em 0";
      selectorDiv.style.textAlign = "center";
      selectorDiv.style.borderBottom = "1px solid #ddd";
      selectorDiv.style.marginBottom = "0.7em";

      selectorDiv.style.display = "flex";
      selectorDiv.style.alignItems = "center";
      selectorDiv.style.gap = "10px";
      selectorDiv.style.justifyContent = "center";

      const select = document.createElement("select");
      select.id = "lang-switcher";
      select.style.width = "30%";
      select.style.padding = "0.1em";
      select.style.fontSize = "0.7em";
      select.style.borderRadius = "10px";
      select.style.textAlign = "center";
      select.style.background = "#fff";
      //select.style.border = "1px solid #ccc";

      const currentLang = "{{ i18n_page_locale | default('en') }}";

      const languages = [
          { code: 'en', name: 'English', prefix: '/' },
          { code: 'ru', name: 'Русский', prefix: '/ru/' }
      ];
      
      // get the page path and remove the leading slash
      let pagePath = "{{ page.url | default('') }}".replace(/^\//, '');
      
      // remove current lang prefix from the path
      const currentLangObj = languages.find(lang => lang.code === currentLang);
      if (currentLangObj && currentLangObj.prefix !== '/') {
          // remove the leading slash from the prefix for comparison
          const langPrefixWithoutSlash = currentLangObj.prefix.replace(/^\//, '');
          
          // if the path starts with the lang prefix, delete it
          if (pagePath.startsWith(langPrefixWithoutSlash)) {
              pagePath = pagePath.substring(langPrefixWithoutSlash.length);
              
              // remove the possible remaining leading slash
              pagePath = pagePath.replace(/^\//, '');
          }
      }
      
      console.log("Current lang:", currentLang, "page.url raw:", "{{ page.url }}", "normalized path:", pagePath);
      
      languages.forEach(lang => {
          const option = document.createElement("option");
          let targetUrl;
      
          // build target URL
          if (pagePath === '') {
              // main page
              targetUrl = lang.prefix === '/' ? '/' : lang.prefix;
              // make sure the path ended with a slash
              if (!targetUrl.endsWith('/')) {
                  targetUrl += '/';
              }
          } else {
              // all remaining pages - just combine the prefix and the path
              targetUrl = lang.prefix + pagePath;
          }
      
          option.value = targetUrl;
          option.text = lang.name;
          if (lang.code === currentLang) option.selected = true;
      
          select.appendChild(option);
      });

      const label = document.createElement("div");
      label.style.fontSize = "0.8em";
      label.style.color = "#fff";
      label.style.marginTop = "0.3em";
      label.textContent = "Language / Язык";

      selectorDiv.appendChild(label);
      selectorDiv.appendChild(select);

      // Insert at top of sidebar
      const target = document.querySelector(".wy-side-nav-search");
      if (target) {
        target.insertBefore(selectorDiv, target.firstChild);
      } else {
        console.warn("Could not find .wy-side-nav-search for lang selector");
      }

      select.addEventListener("change", function() {
        if (this.value) window.location.href = this.value;
      });
    });
  </script>
{% endblock %}